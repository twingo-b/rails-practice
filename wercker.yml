box: ruby:2.3.1

services:
  - name: mysql
    id: mysql:5.7
    env:
      MYSQL_ROOT_PASSWORD: $MYSQL_ENV_MYSQL_PASSWORD
      MYSQL_DATABASE: $MYSQL_ENV_MYSQL_DATABASE

build:
    steps:
      - install-packages:
          packages: nodejs mysql-client fonts-ipaexfont-gothic

      - script:
          name: Install PhantomJS
          code: |
            cd /tmp
            wget -O phantomjs-$PHANTOMJS_VERSION-linux-x86_64.tar.bz2 https://bitbucket.org/ariya/phantomjs/downloads/phantomjs-$PHANTOMJS_VERSION-linux-x86_64.tar.bz2
            tar jxf phantomjs-$PHANTOMJS_VERSION-linux-x86_64.tar.bz2
            mv phantomjs-$PHANTOMJS_VERSION-linux-x86_64/bin/phantomjs /usr/local/bin/phantomjs
            rm -rf phantomjs-$PHANTOMJS_VERSION-linux-x86_64.tar.bz2 phantomjs-$PHANTOMJS_VERSION-linux-x86_64

      - script:
          name: Update bundler
          code: gem install bundler

      - bundle-install

      - rails-database-yml:
          service: mysql-docker

      - script:
          name: echo ruby information
          code: |
              echo "ruby version $(ruby --version) running"
              echo "from location $(which ruby)"
              echo -p "gem list: $(gem list)"

      - script:
          name: Set up db
          code: RAILS_ENV=test bundle exec rake db:schema:load

      - script:
          name: rspec
          code: bundle exec rspec

deploy:
    steps:
      - heroku-deploy:
          install-toolbelt: true
          key: $HEROKU_KEY
          key-name: HEROKU_KEY_PAIR
          user: $HEROKU_USER
          app-name: $HEROKU_APP_NAME
      - script:
          name: Update database
          code: heroku run rake db:migrate --app $HEROKU_APP_NAME

